<!DOCTYPE html>
<html>
  <meta charset="utf-8"/>
  <link href="../src/coral.css" rel="stylesheet">
  <link href="../src/coral-blox.css" rel="stylesheet">
  <!-- <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Arvo" /> -->
  <meta name="viewport" content="width=device-width, initial-scale=1">   
  <script src='../src/reeferIE11.js'></script>

  <script src='../src/coral-observe.js'></script>
  <script src='../src/coral-ui.js'></script>
  <script src='../src/coral.js'></script>
  <script src='../src/coral-blox.js'></script>
  <script src='../src/coral-blox-utils.js'></script>
  <script src='../src/coral-virtual.js'></script>
  <script src='../src/fast-json-patch.js'></script>
  <script src='../../js/fastdiffpatch.js'></script> 
<!----  
  <link href="js/css/lmdd.css" rel="stylesheet">
    <script src='./js/lmdd.js'></script>

-->

  <style>
  </style>
  <script>
    function determineDirection(el, pageX, pageY, dir){
        var x = el.offsetLeft + el.offsetWidth/2;        
        var y = el.offsetTop + el.offsetHeight/2;        
        return 1 + (pageX> x ? !dir : !!dir) + 2*(pageY > y ? !dir : !!dir);
    }


    function selectAndFocus(ui, idx, pos) {
      console.log ('SELECT ---- select and focus ')
      var el = ui.rootEl.children[idx]
      if (el) coral.ui.select.set (pos, el.firstChild.firstChild || el)
    }
    
    function insertBefore(newNode, existingNode) { existingNode.parentNode.insertBefore(newNode, existingNode) }


    function cleanNodes(rootEl, keepAttributes) {
      if (cleanNodes.abort) return
      if (coral.ui.DOM.clean(rootEl, keepAttributes)) {
        console.log ('undo ---- setting block')
        globalUndoer.block(true)
      }
    }
   
    function expandBlocks (barr, idx, cl) {
      var narr = coral.ui.DOM.toBlock (cl)//{items: coral.ui.DOM.toBlocks (cl, true)}
      if (narr.items) {
        narr = narr.items
        for (var i=0; i<narr.length; i++) barr.splice(idx+i, 0, narr[i])
      } else barr.push (narr)
      return idx + narr.length
    }

    function getSelectionRootIndex(el) {
      var a = []
      var els = el.querySelectorAll ('.selected')
      if (els.length)
        for (var i=0; i<els.length; i++) a.push (getChildIndexRoot (el, els[i]))
      else a.push (getChildIndexRoot (el, window.getSelection().anchorNode))
      var sel = window.getSelection() 
      els = el.querySelectorAll ('.cui-focus')
      var idx = getChildIndexRoot (el,sel.anchorNode).idx
      for (var i=0; i<els.length; i++) {
        var cinfo = getChildIndexRoot (el, els[i])
        els[i].classList.toggle ('cui-focus', idx==cinfo.idx)
      }
      els = el.children
      if (els[idx]) els[idx].classList.toggle ('cui-focus', true)
      return a
    }

    function extractHTML (el, getchild) { //make sure you save currentSel in advance
      if (!el) return null
      var div = document.createElement('div');
      //console.log ('undo ---- setting block for new')
      //globalUndoer.block(true)
      var sel = coral.ui.select.get (el)
      
      coral.ui.select.set ({start: 0, end: sel.start, el:el})
      text = window.getSelection().getRangeAt(0).cloneContents()
      div.appendChild (text.cloneNode(true))
      if (getchild && div.firstChild) div = div.firstChild
      var before = div.innerText ? div.innerHTML : ''
      div.innerHTML =  ''

      coral.ui.select.set ({el:el, start: sel.end, end: -1})
      text = window.getSelection().getRangeAt(0).cloneContents()
      div.appendChild (text.cloneNode(true))
      if (getchild && div.firstChild) div = div.firstChild
      var after = div.innerText ? div.innerHTML : ''
      
      coral.ui.select.set (sel, el)
      return {before: before, after: after}

    }

    /*
    coral.ui.register ('cui-editor-controls', {
      state: {
        target: null
      },
      update: function() {
        if (!this.rootEl.cuiInit) {
          this.rootEl.cuiInit = true
          this.rootEl.setAttribute ('style', 'position:fixed; left:0; top: 0; height:0')
          console.log (this.state.target)
        }
        this.html (null, '<div>‚Ü∂</div>')
      }
    })
*/
    coral.ui.register ('cui-editor', {
      state: {
        blocks: [{"type":["h2"],"data":"Editor.js","id":"vvw2f2"},{"type":["p"],"data":"Hey. Meet the new Editor. On this page you can see it in action ‚Äî try to edit this text.","id":"qgwzg5"},{"type":["h3"],"data":"Key features","id":"k6kzwd"},{"type":["li"],"data":"It is a block-styled editor","id":"12yrf0"},{"type":["li"],"data":"It returns clean data output in JSON","id":"co7pt9"},{"type":["li"],"data":"Designed to be extendable and pluggable with a simple API","id":"ot0v96"},{"type":["h3"],"data":"What does it mean ¬´block-styled editor¬ª","id":"3ys885"},{"type":["p"],"data":"Workspace in classic editors is made of a single contenteditable element, used to create different HTML markups. Editor.js workspace consists of separate Blocks: paragraphs, headings, images, lists, quotes, etc. Each of them is an independent contenteditable element (or more complex structure) provided by Plugin and united by Editor's Core.","id":"bk44nl"},{"type":["p"],"items":[{"data":"There are dozens of "},{"type":["a"],"a":{"href":"https://github.com/editor-js"},"data":"ready-to-use Blocks"},{"data":" and the "},{"type":["a"],"a":{"href":"https://editorjs.io/creating-a-block-tool"},"data":"simple API"},{"data":" for creation any Block you need. For example, you can implement Blocks for Tweets, Instagram posts, surveys and polls, CTA-buttons and even games."}],"id":"l52zka"},{"type":["h3"],"data":"What does it mean clean data output","id":"ldqfcn"},{"type":["p"],"data":"Classic WYSIWYG-editors produce raw HTML-markup with both content data and content appearance. On the contrary, Editor.js outputs JSON object with data of each Block. You can see an example below","id":"z7gxpj"},{"type":["p"],"data":"Given data can be used as you want: render with HTML for Web clients, render natively for mobile apps, create markup for Facebook Instant Articles or Google AMP, generate an audio version and so on.","id":"9tskln"},{"type":["p"],"data":"Clean data is useful to sanitize, validate and process on the backend.","id":"yea0ks"},{"type":["p"],"data":"We have been working on this project more than three years. Several large media projects help us to test and debug the Editor, to make it's core more stable. At the same time we significantly improved the API. Now, it can be used to create any plugin for any task. Hope you enjoy. üòè","id":"u9klq2"},{"type":["img"],"img":{"src":"https://codex.so/public/app/img/external/codex2x.png"},"data":"","id":"oa3h9d"},{"type":["p"],"data":" Select an Image","id":"vyrlee"}],
        ____blocks: [{type:['p'], data:'test'}, {type:['cui-ed-oembed'], data:'test'}],
        __blocks: [{"type":["cui-ed-image"],"src":"https://codex.so/public/app/img/external/codex2x.png","caption":{"type":["span"],"data":"Appreciation or even love texts for her to admire and remind her to take care. Here are some long love messages for your girlfriend, long love messages for her from the heart, and cute love paragraphs for your girlfriend. Why long messages? Because, the longer your message is, the longer the hug you are getting from her!"},"id":24}],
       ___blocks: [{"type":["cui-ed-image"],"src":"https://codex.so/public/app/img/external/codex2x.png","caption":{"type":["span"],"data":"testcaption"},"id":24}, {"type":["h2"],"data":"Editor.js","id":"evvbbg"},{"type":["p"],"data":"Hey. Meet the new Editor. On this page you can see it in action ‚Äî try to edit this text.","id":"03fknj"},{"type":["h3"],"data":"Key features","id":"xuiifh"},{"type":["li"],"data":"It is a block-styled editor","id":"ssl6cm"},{"type":["li"],"data":"It returns clean data output in JSON","id":"giqqyf"},{"type":["li"],"data":"Designed to be extendable and pluggable with a simple API","id":"yclpld"},{"type":["h3"],"data":"What does it mean ¬´block-styled editor¬ª","id":"f0avp2"},{"type":["p"],"data":"Workspace in classic editors is made of a single contenteditable element, used to create different HTML markups. Editor.js workspace consists of separate Blocks: paragraphs, headings, images, lists, quotes, etc. Each of them is an independent contenteditable element (or more complex structure) provided by Plugin and united by Editor's Core.","id":"b4pjmi"},{"type":["p"],"items":[{"data":"There are dozens of "},{"type":["a"],"a":{"href":"https://github.com/editor-js"},"data":"ready-to-use Blocks"},{"data":" and the "},{"type":["a"],"a":{"href":"https://editorjs.io/creating-a-block-tool"},"data":"simple API"},{"data":" for creation any Block you need. For example, you can implement Blocks for Tweets, Instagram posts, surveys and polls, CTA-buttons and even games."}],"id":"y7sdri"},{"type":["h3"],"data":"What does it mean clean data output","id":"u37fvu"},{"type":["p"],"data":"Classic WYSIWYG-editors produce raw HTML-markup with both content data and content appearance. On the contrary, Editor.js outputs JSON object with data of each Block. You can see an example below","id":"lsizqf"},{"type":["p"],"data":"Given data can be used as you want: render with HTML for Web clients, render natively for mobile apps, create markup for Facebook Instant Articles or Google AMP, generate an audio version and so on.","id":"r279zx"},{"type":["p"],"data":"Clean data is useful to sanitize, validate and process on the backend.","id":"rxbxrw"},{"type":["p"],"data":"We have been working on this project more than three years. Several large media projects help us to test and debug the Editor, to make it's core more stable. At the same time we significantly improved the API. Now, it can be used to create any plugin for any task. Hope you enjoy. üòè","id":"h70a8p"},{"type":["img"],"img":{"src":"https://codex.so/public/app/img/external/codex2x.png"},"data":"","id":"dnt004"},{"type":["p"],"data":" Select an Image","id":"q1jy0z"}],
        blocsk_:[{"type":["h2"],"data":"Editor.js","id":17},{"type":["p"],"data":"Hey. Meet the new Editor. On this page you can see it in action ‚Äî try to edit this text.","id":1}],
        _blocks:[{"type":["cui-ed-image"],"src":"https://codex.so/public/app/img/external/codex2x.png","caption":{"type":["span"],"data":"testcaption"},"id":24},{"type":["h2"],"data":"Editor.js","id":300},{"type":["p"],"data":"Hey. Meet the new Editor. On this page you can see it in action ‚Äî try to edit this text.","id":2},{"type":["h3"],"data":"Key features","id":3},{"type":["li"],"data":"It is a block-styled editor","id":4},{"type":["li"],"data":"It returns clean data output in JSON","id":5},{"type":["li"],"data":"Designed to be extendable and pluggable with a simple API","id":6},{"type":["h3"],"data":"What does it mean ¬´block-styled editor¬ª","id":7},{"type":["p"],"data":"Workspace in classic editors is made of a single contenteditable element, used to create different HTML markups. Editor.js workspace consists of separate Blocks: paragraphs, headings, images, lists, quotes, etc. Each of them is an independent contenteditable element (or more complex structure) provided by Plugin and united by Editor's Core.","id":18},{"type":["p"],"items":[{"data":"There are dozens of "},{"type":["a"],"a":{"href":"https://github.com/editor-js"},"data":"ready-to-use Blocks"},{"data":" and the "},{"type":["a"],"a":{"href":"https://editorjs.io/creating-a-block-tool"},"data":"simple API"},{"data":" for creation any Block you need. For example, you can implement Blocks for Tweets, Instagram posts, surveys and polls, CTA-buttons and even games."}],"id":9},{"type":["h3"],"data":"What does it mean clean data output","id":10},{"type":["p"],"data":"Classic WYSIWYG-editors produce raw HTML-markup with both content data and content appearance. On the contrary, Editor.js outputs JSON object with data of each Block. You can see an example below","id":19},{"type":["p"],"data":"Given data can be used as you want: render with HTML for Web clients, render natively for mobile apps, create markup for Facebook Instant Articles or Google AMP, generate an audio version and so on.","id":20},{"type":["p"],"data":"Clean data is useful to sanitize, validate and process on the backend.","id":21},{"type":["p"],"data":"We have been working on this project more than three years. Several large media projects help us to test and debug the Editor, to make it's core more stable. At the same time we significantly improved the API. Now, it can be used to create any plugin for any task. Hope you enjoy. üòè","id":22},{"type":["p"],"data":" Select an Image","id":15},{"type":["img"],"img":{"src":"https://codex.so/public/app/img/external/codex2x.png"},"data":"","id":16},{"type":["p"],"data":"\n\n","id":23}]
      },
      data: {
        mousedir: 0,
        init: false,
        flags: {

        }
      },
      update: function () {
        if (this.data.flags.noupdate) return
        var barr = this.state.blocks
        if (!this.data.init) {
          //this.rootEl.tabIndex = 0
          //this.rootEl.contentEditable = true
          this.data.init = true
        }
        var virt = virtualBinder (this.rootEl)

        if (!barr.length) barr.push ({data:''})
        for (var i=0; i<barr.length; i++) {
          var b = barr[i]
          if (!b) {
            console.error (barr, i)
            continue
          }
          if (!b.id) {
            b.id = generateUID()
            var addedProp = true
          }
          /*var h = '<div coral=texter style="min-width:100px; min-height:1em; border: 1px solid #ccc;"" coral-s-idx="' + i + '">' + 
                  '<script type="coral-s-contents">' + b.data + '<\/script></div>'
          */
         var e = this.rootEl.children[i]
         var t = 'div'//b.type || 'div'
         var selclass = ((e && e.classList.contains('selected'))?' selected':'')
         var focclass = ((e && e.classList.contains('cui-focus'))?' cui-focus':'')
         /*var h = '<' + t  + ' contenteditable=true style="margin-left: '+ ((b.indent||0)*32) + 'px;" coral-on-keydown=methods.keydown ' + 
                 'class="item cui-editor-item cui-editor-' + (b.type||'_') + '">' + (b.data||'') + '</' + t + '>'
                 //'coral-on-keydown=methods.keydown>' + (b.data||'&nbsp;') + '</div>'*/
          var h = coral.ui.DOM.toHTML (b)
          var ht = '<div style="margin-left: '+ ((b.indent||0)*32) + 'px;" ' + 
                   'class="item cui-editor-item cui-editor-' + ((b.type && b.type[0])||'_') + '">'
          this.html (b.id || i, '<div draggable=false class="class=cui-editor-wrapper ' + selclass + focclass + '">' + ht + h + '</div></div>')
        }
        var sel = coral.ui.select.get(this.rootEl)
        this.htmlEnd()
        //if (sel.el === this.rootEl) coral.ui.select.set(sel)
        if (addedProp) coral.observe(this.state)
        return 'done'
      },
      lifecycle: {
        afterRender: function () {
          if (this.data.flags.noafterrender) return
          if (!this.data.forceReadFromDOM) return
          this.methods.readFromDOM(this.data.forceReadFromDOM)
          this.data.forceReadFromDOM = false
        }
      },
      methods: {
        getJSON: function () {
          var json = JSON.stringify(this.state.blocks)
          return json//.replace (/coral-modified=\\"([0-9])+\\"/g, '')
        },
        setJSON: function (json) {
          json = typeof(json)==='string' ? JSON.parse(json) : json
          this.state.blocks = json
          this.data.forceReadFromDOM = true
        },
        selection: function (sel) {

        },
        copyToClipboard: function(event) {
          var els = this.rootEl.querySelectorAll('.selected')
          if (!els.length) return
          var h = ''
          var t = ''
          var cels = this.rootEl.children
          for (var i=0; i<els.length; i++) {
            var cinfo = getChildIndexRoot (this.rootEl, els[i])
            var cel = cinfo.el.children[0]
            t += cel.innerText
            h += cel.innerHTML
          }
          //h = h.replace (/coral-modified=\"([0-9])+\"/g, '')
          if (event.clipboardData) {
            event.clipboardData.setData('text/plain', t);
            event.clipboardData.setData('text/html', h);
            console.log ('direct copy', h)
          } else {
            var div = document.createElement('block')
            div.setAttribute ('style', 'position:fixed;opacity:0;')
            div.tabIndex = -1
            div.contentEditable = true
            div.innerHTML = h
            var sel = coral.ui.select.get(this.rootEl)
            document.body.appendChild (div)
            var dummy = document.createElement('pre')
            dummy.innerHTML = '<!--- dummy --->nbsp;'
            div.appendChild (dummy)
            //coral.ui.select.set ({el:div, start:0, end: -1})
            var range = document.createRange();
            range.setStart(div.firstChild, 0);
            range.setEnd(div.childNodes[div.childNodes.length - 1], 0);
            document.getSelection().removeAllRanges();
            document.getSelection().addRange(range);

            document.execCommand("copy");
            div.parentNode.removeChild(div)
            sel.el = this.rootEl
            coral.ui.select.set (sel)
            console.log ('indirect copy', div, div.innerHTML)
          }
          event.preventDefault()
          return true
        },
        readFromDOM: function (force, inidx) {
          if (this.data.flags.noreadfromdom) return
          var els = this.rootEl.children
          var barr = this.state.blocks
          var bi = (inidx|0) || 0
          var bin = bi
          var diff 
          for (var i=bi; i<(inidx===undefined ? els.length : bin+1); i++) {
            if (!els[i]) continue
            var ch = els[i].firstChild
            cleanNodes(ch, true)
            //var elsch = ch.children; for (var n=0; n<elsch.length; n++) cleanNodes (elsch[n], true)
            var narr = coral.ui.DOM.toBlocks (ch)
            if (narr) {
              for (var n=0; n<narr.length; n++) {
                if (n>0) {
                  els[i].__coral_dirty__ = true
                  globalUndoer.block(true)
                  barr.splice (++bi, 0, narr[n])
                } else {
                  if (barr[bi].id) narr[n].id = barr[bi].id
                  if (barr[bi].indent) narr[n].indent = barr[bi].indent
                  var bj = JSON.stringify(barr[bi])
                  var nj = JSON.stringify(narr[n])
                  if (bj !== nj) {
                    //cleanNodes (ch.children[n], true)
                    narr[n] = coral.ui.DOM.toBlock (ch.children[n])
                    if (barr[bi].id) narr[n].id = barr[bi].id
                    if (barr[bi].indent) narr[n].indent = barr[bi].indent
                    diff = true
                    barr[bi] = narr[n]
                  } 
                }
              }
            }
            bi++
          }
          if (barr.length !== bi && inidx === undefined) {
            barr.length = bi
            diff = true
          }
          if (diff) barr.splice(0, 0)
          //if (diff) console.log (barr)
          return diff ? barr : null
          
        },

        clearselectedrows: function (ch, event) {
          if (ch && event && event.key.length>1) return
          if (event) event.preventDefault()


          var ui = this
          var _b = this.state.blocks
          var ui = this
          var els = this.rootEl.children
          var textIn, textElIndex
          for (var i=els.length-1; i>=0; i--) {
            var el = els[i]
            if (!el.classList.contains('selected')) continue; 
            console.log ('desel', i)
            el.classList.remove ('selected')
            if (!textIn && ch) { textIn = _b[i].data = event ? event.key : '' }
            else  _b.splice(i, 1)
            textElIndex = i; 
          }
          if (textIn) { 
            if (!ch) {
                //this.rootEl.focus()
                coral.ui.select.set ({start: 0, end:0}, !textElIndex ? ui.rootEl : ui.rootEl.children[textElIndex])
            }   else coral.ui.select.set (null, ui.rootEl.children[textElIndex], textIn.length) 
          }

        }
      },
      listeners: {
        "coral-popup": function (event) {
          var command = event.detail.item
          switch (command.cmd) {
            case 'undo': globalUndoer.undo(); break 
            case 'redo': globalUndoer.redo(); break
          }
        },
        "contextmenu": function (event) {
          var pop = coral.ui.find ('[coral=cui-popup]')
          if (pop) pop.methods.pop (100,100)
          event.preventDefault()
          return false
        },
        "dragstart.local": function (event) {
          event.preventDefault()
        },
        "focus.local": function(event) {
          console.log ('focus', event.target)
          return
        },
        "blur.local": function(event) {
          console.log ('blur', event.target)
          return
        },
        "click": function(event) {
          console.log ('click', event.target, 'focus:', document.activeElement)
          if(!this.preserveSelection && !this.rootEl.contains( document.activeElement))
            coral.ui.select.set(0, event.target)
          return
        },
        //input: function (event) { this.methods.readFromDOM (false, getChildIndexRoot(this.rootEl, event.target).idx); globalUndoer.push() },
        //change: function (event) { this.methods.readFromDOM (false, getChildIndexRoot(this.rootEl, event.target).idx); globalUndoer.push() },
        keydown: function (event) {
          //if (!event.ctrlKey) return
          var sel = coral.ui.select.get(this.rootEl)//window.getSelection()
          var selNode = sel.startNode//anchorNode
          var cinfo = getChildIndexRoot (this.rootEl, selNode || event.target)
          var ui = this
          var _b = this.state.blocks
          var key = event.key || event.keyCode
          event.code = event.code || ('Key' + event.key.toUpperCase())
          if (key==='Enter' && !event.shiftKey) {
            event.preventDefault()
            var idx = cinfo.idx
            var b = _b[idx] = _b[idx] || {}
            var cel = cinfo.el.children[0]
            cel = cel.firstChild || cel
            var cut = extractHTML (cel)
            console.log ('extract', cut)
            if (cut) {
              var text = coral.ui.DOM.toBlock (cut.after) || {type:['p'], data: cut.after}
              if (cut.before && text.type[0]!=='p') text.type = ['p']
              if (cut.before) {
                var be = cel.cloneNode(false)
                be.innerHTML = cut.before
                b = coral.ui.DOM.toBlock (be) || {type:['p'], data: cut.before}
              } else b = {type:['p'], data: cut.before}
              if (b) {
                b.id =  _b[idx].id
                _b[idx] = b 
              } else { 
                b =_b[idx]
                if (b.data) delete b.data
                if (b.items) delete b.items 
              }
              coral.observe(_b)
            }
            this.state.blocks.splice (idx + 1, 0, text)
            this.methods.clearselectedrows()
            this.render_()
            selectAndFocus (this, idx + 1)
          }
          if (key==='Backspace') {
            var pos = coral.ui.select.get (cinfo.el)
            if (pos.start >= pos.end - 1 && pos.start === 0 && cinfo.idx>0) {
              event.preventDefault()
              var idx = cinfo.idx
              var b = _b[idx-1]
              var bd = _b[idx]
              if (!coral.ui.DOM.combineBlocks (b, bd)) {
                // $$$SREE - do something - select?  toaster?
                return
              }
              _b.splice (cinfo.idx, 1)
              var els = ui.rootEl.children
              pos = coral.ui.select.get (els[idx-1])
              this.methods.clearselectedrows()
              this.render_()
              selectAndFocus (this, Math.max(0, idx-1), pos.count)
              return
            }
          }
          if (event.ctrlKey || event.cmdKey) {
            if (event.code=='KeyZ') {
              event.preventDefault()
              globalUndoer.undo()
              return
            }
            if (event.code=='KeyY') {
              event.preventDefault()
              globalUndoer.redo()
              return
            }
            if (event.code=='KeyX') {
              this.methods.copyToClipboard(event)
              this.methods.clearselectedrows()
            }
            if (event.code=='KeyC')
              this.methods.copyToClipboard(event)

            //console.log(event.code)
            if (event.code=='KeyA') {
              if (this.rootEl.querySelectorAll('.selected') === this.rootEl.children.length) {
                e.preventDefault()
                return
              } 
              if (cinfo && !cinfo.el)
              cinfo.el = cinfo.el
              if (!cinfo || !cinfo.el || !cinfo.el.classList.contains ('selected')) {
                if (cinfo.el) cinfo.el.classList.add ('selected')
                //coral.ui.select.set ({start:0, end:0}, cinfo.el)
                this.preserveSelection = true
              } else {
                coral.dot.arrayApply (this.rootEl.children, 'classList.add', 'selected')
              }
              event.preventDefault()
              event.stopPropagation()
              return
            }
            if (event.code=='ArrowUp' || event.code=='ArrowDown') {
             // var sels = getSelectionRootIndex()
              var _b = this.state.blocks
              var b = _b[cinfo.idx]
              var nidx = cinfo.idx + (event.code=='ArrowUp' ? -1 : 1)
              if (nidx < 0 || nidx >= _b.length) return
              _b.splice (cinfo.idx, 1)
              _b.splice (nidx, 0, b)
              selectAndFocus (this, nidx, 0) 
              return
            }
            if (event.code=='ArrowLeft' || event.code=='ArrowRight') {
              var nodes =this.rootEl.querySelectorAll('.selected')
              if (!nodes.length && selNode) nodes = [selNode]
              for (var i=0; i<nodes.length; i++) {
                var cinfo = getChildIndexRoot(this.rootEl, nodes[i])
                var b = this.state.blocks[cinfo.idx]
                if (!b) continue 
                var maxIndent = ((this.state.blocks[cinfo.idx-1]||{}).indent||0)+1
                var indent = Math.min( Math.max(0, (b.indent||0) + (event.code=='ArrowLeft' ? -1 : 1)), maxIndent)
                b.indent = indent
                coral.observe (b)
              }
              globalUndoer.push()
              event.preventDefault()
            }
            return 
          }
          if (event.code=='ArrowUp' || event.code=='ArrowDown') {
            var cinfo = getChildIndexRoot(this.rootEl, event.target)
            var res = coral.ui.select.test(cinfo.el, event.code, 24)
            if (res) {
              var ui = this 
              var idx = cinfo.idx + res
              cinfo.el.scrollIntoView( {block:'nearest', inline:'nearest', behavior:'auto'})
              var els = ui.rootEl.children
              if (idx >=0 && idx < els.length) {
                var el =els[idx]
                cinfo.el.savedRange = {next: cinfo.idx, range: coral.ui.select.get()}////saveSelection()}
                console.log ("move", idx-res, res)
                if (!event.shiftKey) {
                  if (0 && el.savedRange && el.savedRange.next == idx) coral.ui.select.set(el.savedRange.range)////restoreSelection(el.savedRange.range)
                  else if (res < 0) coral.ui.select.set (-1, el.firstChild ? (el.firstChild.firstChild || el.firstChild) : el)
                  else coral.ui.select.set (0, el.firstChild ? (el.firstChild.firstChild || el.firstChild) : el)
                  delete el.savedRange
                } else {
                  //this.rootEl.cinfo.idx
                }
              }
              event.preventDefault()
            }
          }

          var qs = this.rootEl.querySelector('.selected')
          if (!selNode || qs) {
            idx = getChildIndexRoot(this.rootEl, qs).idx
            console.log (event)
            this.methods.clearselectedrows ((event.keyCode==8 || event.keyCode==46) ? '' : event.keyCode, event)
            this.render_()
            console.log ('sel:', idx)
            selectAndFocus (this, idx, 1) 
          }
        },
        
        "cut.local": function (event) {
          this.methods.copyToClipboard(event)
          this.methods.clearselectedrows()
        },
        "copy.local": function (event) {
          this.methods.copyToClipboard(event)
        },
        "paste.local": function(event) {
          var ui = this
          var text
          var html = event.clipboardData.getData('text/html')
          if (html) {
            var html = html.split('<!--StartFragment-->')
            html = html.length > 1 ? html[1] : html[0]
            html = html.split('<!--EndFragment-->')[0]
            console.log (html)
            var inel = document.createElement ('p')
            //html = html.replace(/\>(\t|\s|\n|\r)*\</g, '><').trim()
            inel.innerHTML = html 
            //h = ''; var els = inel.children; for (var i=0; i<els.length; i++) h+=els[i].outerHTML; inel.innerHTML = h;
            var block = globalUndoer.block()
            cleanNodes(inel)
            inel.normalize()
            text = inel.innerHTML
          } else text = event.clipboardData.getData('text')
          
          event.preventDefault()
          if (!text) return
          globalUndoer.block (block)
          console.log ('undo ---- clearing unnecessary block: ', block)
          var sels = this.rootEl.querySelectorAll('.selected')
          if (sels.length) {
            var idx, nidx
            var idx = getChildIndexRoot (this.rootEl, sels[0]).idx
            this.methods.clearselectedrows()
            //this.state.blocks.splice (idx, 0, {data: ''})
            if (inel) 
              nidx = expandBlocks (this.state.blocks, idx, inel)
            this.render_()
            if (nidx !== undefined) selectAndFocus (this, nidx, 0)
            //if (!this.state.blocks[idx].data) this.state.blocks.splice (idx, 1)
          } else {
            document.execCommand('insertHTML', false, (inel && inel.innerHTML) || text);
            this.methods.readFromDOM ()
          }
        },
        "pointerdown": function(event) { 
          console.log (event, 'mouse')
          this.data.mousedown = getChildIndexRoot(this.rootEl, event.target) 
          if (this.data.drag) this.data.drag.end()
          this.data.drag = startDragRectangle(event.clientX, event.clientY)
          var cinfo =  getChildIndexRoot(this.rootEl, event.target)
          this.data.drag.target = cinfo.el
          if (!this.data.drag.target) {
            this.data.drag.moving = true
            event.target.setPointerCapture (event.pointerId)
          }
          //event.preventDefault()
        },
        "pointerup": function(event) { 
          var els = this.rootEl.querySelectorAll('.selected')
          if (els.length) {
            this.preserveSelection = true
            coral.ui.select.set({start:0, end:-1}, els[0])
          }
          this.data.mousedown = null 
          if (this.data.drag) this.data.drag = this.data.drag.end()
          event.target.releasePointerCapture (event.pointerId)
          if(!this.preserveSelection && !this.rootEl.contains( document.activeElement))
            coral.ui.select.set(0, this.rootEl)
          //event.preventDefault()

        },
        "pointermove": function(event) {
          var cinfo = getChildIndexRoot(this.rootEl, event.target)
          if (cinfo.idx>=0 && this.data.drag && cinfo.el!==this.data.drag.target) {
            this.data.drag.moving = true
            event.target.setPointerCapture (event.pointerId)
          }
          if (this.data.drag && this.data.drag.moving) this.data.drag.move(event.clientX, event.clientY)
          if (!this.data.mousedown) return 
          //event.preventDefault()
          var target = document.elementFromPoint (event.clientX, event.clientY)
          var cinfo = getChildIndexRoot(this.rootEl, target)
          if (cinfo.idx<0) return
          if (cinfo.el !== this.data.mousedown.el || cinfo.el === this.data.mousedown.anchor ) {
            this.data.mousedown.anchor = this.data.mousedown.el
            var range = window.getSelection()
            range.removeAllRanges()
            if (this.data.mousedown.idx<0) this.data.mousedown.idx = cinfo.idx
            var start = Math.min (cinfo.idx, this.data.mousedown.idx)
            var end = Math.max (cinfo.idx, this.data.mousedown.idx)
            var els = this.rootEl.children
            for (var i=0; i<els.length; i++) els[i].classList.toggle ('selected', i==this.data.mousedown.idx || (i>=start && i<=end))
          }

        },
        "pointerout": function(event) {
          return
          /*
          console.log ("pointerleave", event)
          if (!this.data.drag) return
          console.log ("leavning", event.target)
          if (event.target===this.data.drag.target) {
            this.data.drag.moving = true
            event.target.setPointerCapture (event.pointerId)
          }
          return
          var cinfo = getChildIndexRoot(this.rootEl, event.target)
          var range = window.getSelection()
          range.removeAllRanges()
          var dir =determineDirection(this.rootEl, event.pageX, event.pageY, 0)
          if (this.data.mousedown && this.data.mouseDir !== dir) {
            setTimeout(function() {this.rootEl.classList.toggle ('selected')}, 0)
          }
          this.data.mouseDir = 0
          */
        },
      }
    })
    function quoteArr(arr) { var s = ''; for (var i=0; i<arr.length; i++) s += (i===0?'':', ') + arr[i] + ''; return s }
    function jsonprint (key, value) {
      if (key==='type') return '[' + quoteArr(value) + ']'
      return value
    }
    function jout(o, tabs) {
      var tabs = tabs || ' ', t = ''
      tabs = ''
      var h = ''
      var isarr = Array.isArray(o)
      for (var k in o) {
        var v = o[k]
        if (typeof(v)==='string') v = coral.ui.DOM.escapeHTML(v)
        var ok = k
        if (t) h += '\n'
        if (Array.isArray(v) && k!=='type') {
          h += t + '<details open "><summary><code>' + k + '</code></summary><pre style="padding:6px;margin:0;overflow:visible">' 
          h += jout (v, tabs + '&nbsp;&nbsp;&nbsp;')
          h += '</pre></details>'
        } else {
          if (!isarr) h += t + k + ': '
          h += JSON.stringify(v) 
        }
        h += '\n'
        t = tabs
      }
      return h
    }
    document.addEventListener('selectionchange', function(event) {
      console.log ('selection change event')
      var uis = coral.ui.findAll ('[coral=cui-editor]')
      var els = [] 
      const s = window.getSelection();

      var sel = coral.ui.select.get()
      var ss = sel.startNode
      while (ss) {
        if (ss.coral) {// && ss.coral.name === 'cui-editor') {
          ss.coral.savedSelection = sel
          break
        }
        ss = ss.parentNode
      }
      /*

      if (coral.ui.select.savedASelection) {
        var ss = coral.ui.select.savedASelection
        if (s.startOFfset === ss.startOFfset && 
            s.endOffset === ss.endOffset && 
            s.startContainer === ss.startContainer &&
            s.endContainer === ss.endContainer)
            return false
      }
      coral.ui.select.savedASelection = false
      */
      if (uis.length && 1) {
        var cinfos = getSelectionRootIndex(uis[0].rootEl)
        var barr = uis[0].state.blocks 
        var h = ''
        for (var i=0; i<cinfos.length; i++) {
          if (cinfos[i].idx>=0) 
            h += '<pre style="padding:6px">' + jout(barr[cinfos[i].idx]) + '</pre>'
        }
        if (h) jsonout.innerHTML = h
      }
      
      for (var i=0; i<uis.length; i++) {
        if (uis[i].preserveSelection) { 
          uis[i].preserveSelection = false; 
          continue; }
        for (var j=0; j<uis[i].rootEl.children.length; j++) els.push (uis[i].rootEl.children[j])
      }
      for (var i=0; i<els.length; i++) if (els[i].classList.contains('selected')) els[i].classList.remove ('selected')
      globalUndoer.select()
      const isExtent = function (node){
        return node instanceof Element && node.classList.contains('container');
      };
      if (0)
      for (var i=0; i<uis.length; i++) {
        var root = uis[i].rootEl
        var start = getChildIndexRoot(root, s.anchorNode)
        var end = getChildIndexRoot(root, s.extentNode)
        els = root.children
        if (els.length)
        if ((start.idx==0 && s.anchorOffset===0 && 
             end.idx==root.children.length-1 && s.extentOffset >= s.extentNode.length - 1) || 
             (s.containsNode && s.containsNode(els[0]) && s.containsNode(els[els.length - 1]))) {
          s.removeAllRanges();
          coral.ui.select.set(null, root)
          uis[i].preserveSelection = true
          for (var i=0; i<els.length; i++) if (!els[i].classList.contains('selected')) els[i].classList.add ('selected')
        }
      }

    });

  </script>
<body style='background-color: #f7f7f7;'>
  <div id=result></div>
  <div class="in" id="myedit" contenteditable="" style="opacity:0.5">
    contenteditable<br><br>
  </div>
  <div s  tyle='max-width:1200px; margin: 0 auto; padding-bottom:16px'>
    <h1>coral.blox</h1>
  </div>
  <details style='margin-bottom:8px;'>
    
    <summary >
      Show JSON of the active block(s).  Select All to see the entire doc:
    </summary>
    <div id=jsonout  style='overflow:auto; height:200px;'></div>
  </details>
  
  <div class='container' coral='cui-editor' ></div>
  <div coral_='cui-editor-controls' coral-s-target='~rootEl~.container'></div>

  <div style="margin-top:20px;">
    <h3>Text output:</h3>
    <div id="text-output"></div>
  </div>
  <div style="margin-top:20px;">
    <h3>HTML output:</h3>
    <pre id="html-output"></pre>
  </div>
<!--
    <script src='https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.js'></script>
-->
  <div style='position:fixed; z-index:999' >
    <div coral="cui-editor-buttons" class='cui-horizontal cui-align' 
         style='box-shadow:0 -5px 10px white; position:fixed; height:40px; bottom:0; Left:0; right:0; background:rgba(255,255,255,0.9); border-top:1px solid rgba(0,0,0,0.1);'
         coral-s-datasrc='state.list'>
        <script type='coral-template(d,i)'>
          <button coral-index=${i} style="color:#aaa; border:none; background:rgba(255,255,255,0.5); margin-left:4px; padding:8px 12px">${d.label}</button>
        </script>
        <script type='coral-s-list'>
          [ {"label":"‚Ü∫", "action":"undo"}, {"label":"‚Üª", "action":"redo"},{"label": "menu", "action":"menu"} ]
        </script>
    </div>
    <div coral='cui-joystick' class=cui-shadow-white 
      style='border-radius:100%; width:40px; height:40px; bottom: 4px; right: calc(50% - 20px); 
             border:8px solid rgba(0, 0, 0, 0.2); background:rgba(255,255,255,0.9); position:fixed;z-index:1' class='joystick'>
        <div style='border-radius:100%; width:100px; height:100px; bottom: 0; right: 0; opacity: 0.9; background: radial-gradient(rgba(255,255,255,0), rgba(255,255,255,0), #666); position:fixed;z-index:1' class='joystick'>
      </div>
      <div class=cui-fill style='left:-10px; right:-10px; top:-10px; bottom:-10px; border-radius:100%; overflow:hidden'>
        <iframe src='http://localhost:9002/public/webgl/index.html' frameborder=0 height='200px' width='200px'></iframe>
      </div>
    </div>
    <div class='cui-horizontal cui-align' 
        style='justify-content:flex-end; box-shadow:0 -5px 10px white; position:fixed; height:40px; bottom:0; right:0;'
      <label><span style='margin-right:8px; opacity: 0.5' onclick>select</span><input type=checkbox> </label>
    </div>
  </div>  
  <div coral='cui-popup' coral-s-target='[coral=cui-editor]'> 
    <script type='coral-s-list'>
      [
        {"title":"undo", "cmd":"undo"}, {"title":"redo", "cmd":"redo"}
      ]
    </script>
  </div>
<script>
function wclass() { var s=''; for (var i=0; i<arguments.length; i++)  s = s + (s.length ? ' ' : '') + (arguments[i] || ''); return s }
coral.ui.register ('cui-editor-buttons', {
  listeners: {
    "click.local": function(e){
      console.log (e.target)
      var idx =  e.target.hasAttribute('coral-index') ? (e.target.getAttribute('coral-index') | 0) : -1
      if (idx>=0 && idx<this.state.list.length) {
        var l = this.state.list[idx]
        switch (l.action) {
          case 'undo': globalUndoer.undo(); break
          case 'redo': globalUndoer.redo(); break
        }
      } else {
        coral.ui.find ('[coral=cui-popup]').methods.pop (100,100)
      }
      e.stopPropagation()
      e.preventDefault()
    },
    "mousedown.local": function (e) {
      e.stopPropagation()
      e.preventDefault()
    }
  }
})
coral.ui.register('cui-popup', {
  state: {
    x: 0,
    y: 0,
    input: '',
    selected: -1,
    visible: false,
    list: []//{title:'a'}, {title:'b'},{title:'a'}, {title:'b'},{title:'a'}, {title:'b'},{title:'a'}, {title:'b'},{title:'a'}, {title:'b'}, {title:'b'},{title:'a'}, {title:'b'},{title:'a'}, {title:'b'}]
  },
  data: {
    filtered: []
  },
  update: function() {
    var rel = this.rootEl
    if (!this.init) {
      rel.classList.add ('cui-shrinkable')
      rel.classList.add ('cui-vertical')
      rel.classList.add ('cui-shadow')
      if (rel.parentNode !== document.body) {
        docuement.body.appendChild (rel)
      }
      coral.ui.css ('[coral=cui-popup] > div', 'transition: 0.2s all; border: 1px solid #ccc; padding:8px; margin: 1px;')
      this.init = true
    }
    rel.classList.toggle ('cui-shrink', !this.state.visible)
    rel.setAttribute ('style', 'border: 1px solid; black; position: fixed; z-index:1001; background-color:white; top:' + this.state.y + 'px; left:' + this.state.x + 'px;' +  
                                 'transition: max-height 0.3s, margin 0.2s, padding 0.3s;')

    var list = this.state.list
    var inp = this.state.input
    var sel = this.state.selected
    this.html (-1, '<input style="font-size:16px;flex-grow:1; margin:12px" value="' + inp +'" placeholder="enter a command">')
    for (var i=0; i<this.state.list.length; i++) {
      var l = list[i]
      var js = l.title 
      var shrink = (inp && js.toLowerCase().indexOf(inp)<0)
      this.data.filtered[i] = shrink
      var h = '<div coral-index=' + i + ' class="cui-shrinkable ' + wclass(sel==i && 'selected', shrink && 'cui-shrink') + '">' + js + '</div>'
      this.html (i, h)
    }
  },
  methods: {
    options: function (arr) {
      this.state.list = arr
      return this.methods
    },
    pop: function (x, y) {
      var el = typeof (x)==='Node' && x 
      var r = el && el.getBoundingClientRect()
      this.state.x = ((r && r.right) || x)
      this.state.y = ((r && r.bottom) || y)
      this.state.visible = true
      this.rootEl.querySelector('input').focus()
      return this.methods
    },
    select: function(idx) {
      idx = idx | 0
      if (idx >= 0 && idx < this.state.list.length) {
        this.state.selected = idx
        var th = this
        //coral.ui.select.set (th.data.sel)
        setTimeout (function() { 
          //coral.ui.select.set (th.data.sel)
          th.state.visible = false 
          var em = coral.ui.find(th.state.target)
          if (em) {
            //th.data.sel = em.savedSelection || th.data.sel
            //coral.ui.select.set (th.data.sel)
            em.emit ('coral-popup', {item: th.state.list[idx], idx: idx})
          } else console.error ('no target for item', idx)
        }, 150)
        //this.rootEl.tabIndex = -1 
      }
      return this.methods
    }
  },
  observers: {
    'visible': function(updates) {
      var em = coral.ui.find(this.state.target)
      if (this.state.visible) {// && !this.data.sel ) 
        this.data.sel = (em && em.savedSelection) || coral.ui.select.get()
      } else {
        var th = this
        if (this.data.sel) {
          coral.ui.select.set((em && em.savedSelection) || th.data.sel)
          th.data.sel = null
        }
      }
    }
  },
  listeners: {
    input: function (e) { this.state.input = e.target.value;  e.stopPropagation() },
    keydown: function (e) {
      if (e.keyCode === 38 || e.keyCode === 40) {
        do {
          var f = this.data.filtered
          var up = e.keyCode===40 
          var sel = this.state.selected + 1
          var len = (this.state.list.length + 1)
          sel = (sel + (up?1:-1)) % len 
          if (sel < 0) sel = len - sel

          this.state.selected = sel - 1
        } while (f[sel-1])
      } else if (e.keyCode === 13) {
        var el = this.rootEl.querySelector('.selected')
        if (el && el.hasAttribute ('coral-index'))
          this.methods.select  (el.getAttribute ('coral-index'))
      } else if (e.keyCode === 27) {
        this.state.visible = false
      }
      e.stopPropagation()
    }, 
    'mousedown.local': function(e) { 
      if (e.target.nodeName === 'INPUT') return 
      var idx = e.target.getAttribute ('coral-index')
      this.methods.select (e.target.hasAttribute ('coral-index') ? idx : -1)
      e.preventDefault()
    }
  }
})
coral.ui.register('cui-joystick', {
  state: {visible: false},
  data: {
    pos: undefined
  },
  update: function () {
    var fc = this.rootEl.firstElementChild
    if (!fc) 
      return 'done'
    fc.style.display = this.state.visible ? 'block' : 'none' 
    fc.style.position = 'fixed'
    return 'done'
  },
  methods: {
    position: function (e) {
      var fc = this.rootEl.firstElementChild
      if (!fc) return
      fc.style.display = 'block'
      var b = fc.getBoundingClientRect(fc)
      fc.style.left = (e.touches[0].clientX - b.width/2) + 'px'
      fc.style.top = (e.touches[0].clientY - b.height/2) + 'px'

      var dx = (e.touches[0].clientX  - this.data.clientX)/2
      var dy = (e.touches[0].clientY  - this.data.clientY)/2
      this.data.vx = dx/6
      this.data.vy = dy/6
      if (!this.state.interval) {

        var th = this
        var tr = th.data.rects
        var x = (th.data.pos.left + th.data.pos.width/2 + window.pageXOffset) + dx
        var y = (th.data.pos.top + th.data.pos.height/2 + window.pageYOffset)  + dy
        testSetSelection (tr, x, y)
      }
    }
  },
  listeners: {
    'touchstart.local': function (e) {
        this.state.visible=true
        this.data.clientX = e.touches[0].clientX
        this.data.clientY = e.touches[0].clientY
        this.data.nx = 0
        this.data.ny = 0
        this.data.pos = coral.ui.select.coords()
        this.data.node = coral.ui.find('*').rootEl//window.getSelection().anchorNode
        this.data.rects = testRange (this.data.node)
        this.methods.position(e)
        console.log (this.data.pos)
        e.preventDefault()

        var th = this
        if (0)
        this.state.interval = setInterval(function() {
          var tr = th.data.rects
          function lim(a,m) {return a<-m ? -m : (a>m ? m : a)}
            th.data.nx += lim(th.data.vx,8)
            th.data.ny += lim(th.data.vy,8)
          var x = (th.data.pos.left + th.data.pos.width/2 + window.pageXOffset) + th.data.nx
          var y = (th.data.pos.top + th.data.pos.height/2 + window.pageYOffset)  + th.data.ny
          testSetSelection (tr, x, y)

        }, 100)

    },
    'touchmove.local': function (e) {
        this.methods.position(e)
        e.preventDefault()
    },
    'touchend.local': function (e) {
      this.state.visible=false
      e.preventDefault()
      if (this.state.interval) {
        clearInterval(this.state.interval)
        this.state.interval = null
      }
    }
  }
})


var globalUndoer = Undoer(document.querySelector('.container'))
coral.ui.register ('cui-text', {
  state: {
    display: {
      value: ''
    }
  },
  update: function() {
    if (!this.rootEl.contenteditable) this.rootEl.contenteditable = true 
    domchange (this.rootEl)
    this.html (0, this.state.display.value)
  }
})

</script>
</body>
</html>