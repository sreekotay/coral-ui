<html>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src=../src/xs-observe.js></script>
  <script src=../src/reefer.js></script>
  <script src=../src/coral.js></script>
  <link rel="stylesheet" href="../src/coral.css">
<body>

<style>
@keyframes heightAppear { 0%   { max-height: 0; opacity: 0; } 100% { max-height: 200px; opacity: 1;} }
@keyframes heightDisappear { 0%   { max-height: 200px; opacity: 1} 100% { max-height: 0; opacity: 0;} }
@keyframes leftAppear { 0%   { max-height: 0; opacity: 0; left:-100px} 100% { max-height: 200px; opacity: 1; left:0} }
@keyframes rightAppear { 0%   { max-height: 0; opacity: 0; left:100px} 100% { max-height: 200px; opacity: 1; left:0} }
.remove { animation: heightDisappear 0.25s forwards !important; }
.add { animation: leftAppear 0.25s forwards !important; }
.redo { animation: rightAppear 0.25s forwards !important; }

[reef=todos] {
  width:50%;
}
[reef=todos] > div {
  position: relative; 
  overflow: hidden;
}
[reef=todos] label {
  margin: 4px; 
  background-color: #f7f7f7;
  display: flex;
}
[reef=typer] {
  padding: 12px 0px;
  background-color: rgb(255,255,255, 0.9);
}
[reef=typer].reef-stuck {
  border-bottom: 1px solid #ddd;
}

</style>
<div class='coral-vertical' style='width:100%; align-items:center; padding-top: 16px;'>
  <div style='max-width:500px;margin:8px; overflow: auto; height: 500px'>
    <div reef=typer class='reef-sticky''>
      <small reef-slot='hinttext' style="margin-left:4px">(press enter to add)</small>
      <span reef-slot='prompttext'>Type something above to change this text</span>
    </div>
    <div class='coral-horizontal' style='margin-top:16px;'> 
      <div reef=todos id=todo class='coral-vertical' reef-p-targetlist='#done' reef-p-inputtext='~data.target~[reef=typer]' reef@click  reef-p-checkclass = 'redo'
      reef-p-todos='[
      ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"],
      ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"],
      ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"],
      ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"],
      ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"]
      ]'>
        <div reef-slot='header'><b>TODO.</b></div>
        <div reef-slot='footer'><div id='a'>To do footer.</div></div>
      </div>
      <div style='flex-grow:1'></div> 
      <div reef=todos id=done class='coral-vertical' reef-p-targetlist='#todo' reef-p-checked=true reef@click reef-p-checkclass = 'add'
      reef-p-todos='[
        ["Much longer item that we are using.  But still pretty short in the grand scheme of things"],
        ["item 4"],
        ["animated at the top to show animation"],
        ["animated slowly to show the intergrity of the animation"] 
        ]'>
        <div reef-slot='header'><b>DONE.</b></div>
        <div reef-slot='footer'><div id='b'>Done footer.</div></div>
      </div>
    </div>  
  </div>
  <div style='background-color:red; height:1000px; width: 40px'>

  </div>
</div>
<script>
  
    // ================  typer
    reefer.register('typer', {
      data: {
        text: ''
      },
      template: function () {
        var props = this.data
        var slots = this.slots
        var hinttext = (slots && slots.hinttext && slots.hinttext.text) || ''
        var prompttext = (slots && slots.prompttext && slots.prompttext.text ) || ''
        return '\<div style="display:flex; align-items:center">\
          <label for="mirror"><b>New Task</b> </label>\
          <input style="margin-left: 6px; flex-grow:1" type="text" id="mirror" value="' + props.text +'"> \
          <button style="margin-left:4px" reef@click="methods.submitInput">Add</button></div>\
          <div style="text-align:center"><em aria-live="polite">' + (props.text.length ? props.text + hinttext: prompttext) + "</em></div>";
        return html;
      },
      methods: {
        submitInput: function() {
          if (!this.data.text || !('target' in this.data)) return
          this.data.target = this.data.text
          this.data.text = ''
        }
      },
      listeners: {
        input: function(e) {var props = this.data; props.text = e.target.value},
        keydown: function (e) { if (e.key==='Enter') this.methods.submitInput() }
      }
    })

    function verifyAfterElement (el, eof) {
      var a = el.nextSibling 
      if (!a || !a.reefHolder) {
        var d = document.createElement ('div')
        d.style.margin = d.style.padding = 0 
        d.style.display = 'none'
        d.style.border = 'none'
        d.reefHolder = true
        if (a) a.parentNode.insertBefore (d, a)
        else e.parentNode.appendChild (d)
        a = d
      }
      if (!eof) eof = e.lgetBoundingClientRect()
      a.style.width = eof.width
      a.style.height = eof.height
      return a
    }
    function reefStickyScroll() {
      var els = document.getElementsByClassName ('reef-sticky')
      for (var i=0; i<els.length; i++) {
        var el = els[i]
        var pel = el.parentNode
        var eof = el.getBoundingClientRect()
        var pof = pel.getBoundingClientRect()
        var ael = verifyAfterElement (el, eof)
        var npos = Math.min (Math.max(pof.top, 0), pof.bottom - eof.height)
        if (ael.style.display === 'none') {
          if (eof.top < npos) {
            ael.style.display = 'block'
            if (!el.stickyInfo) {
              el.stickyInfo = {}
              el.stickyInfo.position = el.style.position
              el.stickyInfo.zIndex = el.style.zIndex
              el.stickyInfo.top = el.style.top
              el.stickyInfo.width = el.style.width
            }
            el.style.position = 'fixed'
            el.style.width = eof.width
            el.style.zIndex = 1000
            el.classList.add ('reef-stuck')
          }
        } else {
          var aof = ael.getBoundingClientRect()
          if (aof.top > npos) {
            ael.style.display = 'none'
            el.style.position = el.stickyInfo.position
            el.style.zIndex = el.stickyInfo.zIndex
            el.style.top = el.stickyInfo.top
            el.style.width = el.stickyInfo.width
            el.classList.remove ('reef-stuck')
          } 
        }
        if (el.style.top !== npos) el.style.top = npos
      }
    }
    reefStickyScroll.listener = function () {
      if (!reefStickyScroll.ticking) {
        window.requestAnimationFrame(function() {
          reefStickyScroll.ticking = false;
          reefStickyScroll()
        });
        reefStickyScroll.ticking = true;
      }
    }
    reefStickyScroll.apply = function (el) {
      reefStickyScroll.wm = new WeakMap()
      var els = el ? (Array.isArray(el) ? el : [el]) : document.getElementsByClassName ('reef-sticky')
      for (var i=0; i<els.length; i++) {
        var el = els[i]
        while (el) {
          if (!reefStickyScroll.wm.has(el)) {
            reefStickyScroll.wm.set(el)
            el.addEventListener('scroll', reefStickyScroll.listener)
          }

          el = el.parentNode
          if (el===document.body) el = window
        }
      }
    }
    reefStickyScroll.apply()

    // ================  todos
    reefer.register ('todos', {
      data: {
        todos: [],
        datasrc: 'data.todos',
        datactx: 'data',
        genkey: true,
        checked: false,
        addClass: ''
      },
      decorators: ['addClass'],
      slots: {
        default: {
          script: reefer.template('d,i,ctx', 
                                  "<div class='${(ctx.__hmap__[d.__key__])  ? (d.leaving===ctx.__xs__.s ? 'remove' : '') : ctx.addClass}'><label>\
                                      <input type='checkbox' \
                                             reef@click='methods.checkAndAssign' \
                                             ${ctx.checked ?  'checked' : ''}></input>${(!ctx.__hmap__[d.__key__]) || 0? '(new)' : '(old)'}\
                                      <span class=textshadow>${d[0]}</span>\
                                    </label></div>")
        }
      },
      methods: {
        checkAndAssign: function (event) {
          var rf = this
          var idx = this.htmlToIdx(event.target) - 1
          var targetReef = reefer.find (rf.data.targetlist)
          if (!targetReef && targetReef.name!='todos') throw Error ("no target todo list found")
          var todo = rf.data.todos[idx]
          if (todo.leaving) return 


          var elem = this.htmlChild(event.target)
          if (todo.leaving) 
            return //already moving
          todo.leaving = this.data.__xs__.s
          xs.observe (todo)
          targetReef.data.todos.splice (0, 0, todo)
          return
        } 
      },
      lifecycle: {
        afterRender: function () {
          this.data.addClass = this.data.checkclass
        }
      },
      listeners: {
        animationend: function (event) {
          var idx = this.htmlToIdx (event.target) - 1
          if (idx>=0) {
            var todo = this.data.todos[idx]
            if (todo.leaving!==this.data.__xs__.s) return
            todo.leaving = null
            if (idx>=0) this.data.todos.splice (idx, 1)
          }
        }
      },
      observers: {
        inputtext: function() {
          if (!this.data.inputtext) return
          var todo =  [this.data.inputtext]
          this.data.inputtext = ''

          //animating it
          this.data.todos.splice (0, 0, todo)
          this.data.addClass = 'add'
        },
        'todos.*.leaving': function () {
          //return 'done'
        }
      }      
    })

    
    function getOffset(el) {
      if (!el.getClientRects().length) return { top: 0, left: 0 }
      var rect = el.getBoundingClientRect();
      var win = el.ownerDocument.defaultView;
      return {
        top: rect.top + win.pageYOffset,
        left: rect.left + win.pageXOffset,
        width: rect.width,
        height: rect.height 
      }   
    } 

    function reanimate(target, el, duration) {
      duration = duration || 1
      var elpos = getOffset (el)
      var tpos = getOffset (target)
      var nel1 = el.cloneNode (true)
      var nel2 = target.cloneNode (true)
      var d1 = el.parentNode.cloneNode(false)
      var d2 = target.parentNode.cloneNode(false)
      var ds =  {
        margin: '0',
        padding: '0',
        border: 'none',
        display: 'block',
        transition: 'all ' + duration + 's',
        zIndex: 1000,
        overflow: 'hidden'
      }
      nel1.removeAttribute ('id')
      nel2.removeAttribute ('id')
      reefer.styleBag (d1,ds)
      reefer.styleBag (d2,ds)
      document.body.appendChild (d1)
      document.body.appendChild (d2)
      d1.appendChild (nel1)
      d2.appendChild (nel2)
      var p1 =  {
        position: 'absolute',
        left: elpos.left + 'px',
        top: elpos.top + 'px',
        width: elpos.width + 'px',
        height: elpos.height + 'px'
      }
      d1.style.opacity = 1
      d2.style.opacity = 0
      reefer.styleBag (d1, p1)
      reefer.styleBag (d2, p1)
      requestAnimationFrame(function () {
        var p2 =  {
          left: tpos.left + 'px',
          top: tpos.top + 'px',
          width: tpos.width + 'px',
          height: tpos.height + 'px',
        }
        reefer.styleBag (d1,p2)
        reefer.styleBag (d2,p2)
        d1.style.opacity = 0
        d2.style.opacity = 1
        setTimeout (function () {
          document.body.removeChild(d1)
          document.body.removeChild(d2)
        }, (duration*1000)+30)
      })
    }
</script>
</body>
</html>
