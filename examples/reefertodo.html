<html>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src=../xs-observe.js></script>
  <script src=../reefer.js></script>
  <script src=../coral.js></script>
  <link rel="stylesheet" href="../coral.css">
<body>

<style>
@keyframes heightAppear { 0%   { max-height: 0; opacity: 0; } 100% { max-height: 200px; opacity: 1;} }
@keyframes heightDisappear { 0%   { max-height: 200px; opacity: 1} 100% { max-height: 0; opacity: 0;} }
@keyframes leftAppear { 0%   { max-height: 0; opacity: 0; left:-100px} 100% { max-height: 200px; opacity: 1; left:0} }
@keyframes rightAppear { 0%   { max-height: 0; opacity: 0; left:100px} 100% { max-height: 200px; opacity: 1; left:0} }
.remove { animation: heightDisappear 1s forwards !important; }
.add { animation: leftAppear 1s forwards !important; }
.redo { animation: rightAppear 1s forwards !important; }

[reef=todos] {
  width:50%;
}
[reef=todos] > div {
  position: relative; 
  overflow: hidden;
}
[reef=todos] label {
  margin: 4px; 
  background-color: #f7f7f7;
  display: flex;
}

</style>
<div class='coral-vertical' style='width:100%; align-items:center; padding-top: 16px;'>
  <div style='max-width:500px;margin:8px'>
    <div reef=typer >
      <small reef-slot='hinttext' style="margin-left:4px">(press enter to add)</small>
      <span reef-slot='prompttext'>Type something above to change this text</span>
    </div>
    <div class='coral-horizontal' style='margin-top:16px;'> 
      <div reef=todos id=todo class='coral-vertical' reef-p-targetlist='#done' reef-p-inputtext='~data.target~[reef=typer]' reef@click  reef-p-checkclass = 'add'
      reef-p-todos='[
        ["item1"], ["item2"], ["third item"], [ "Darth Vader"], ["me"], ["you"]
        ]'>
        <div reef-slot='header'><b>TODO.</b></div>
        <div reef-slot='footer'><div id='a'>To do footer.</div></div>
      </div>
      <div style='flex-grow:1'></div> 
      <div reef=todos id=done class='coral-vertical' reef-p-targetlist='#todo' reef-p-checked=true reef@click reef-p-checkclass = 'redo'
      reef-p-todos='[
        ["Much longer item that we are using.  But still pretty short in the grand scheme of things"],
        ["item 4"],
        ["animated at the top to show animation"],
        ["animated slowiy to show the intergrity of the animation"] 
        ]'>
        <div reef-slot='header'><b>DONE.</b></div>
        <div reef-slot='footer'><div id='b'>Done footer.</div></div>
      </div>
    </div>  
  </div>
</div>
<script>
  
    // ================  typer
    reefer.register('typer', {
      data: {
        text: ''
      },
      template: function () {
        var props = this.data
        var slots = this.slots
        var hinttext = (slots && slots.hinttext && slots.hinttext.text) || ''
        var prompttext = (slots && slots.prompttext && slots.prompttext.text ) || ''
        return '\<div style="display:flex; align-items:center">\
          <label for="mirror"><b>New Task</b> </label>\
          <input style="margin-left: 6px; flex-grow:1" type="text" id="mirror" value="' + props.text +'"> \
          <button style="margin-left:4px" reef@click="methods.submitInput">Add</button></div>\
          <div style="text-align:center"><em aria-live="polite">' + (props.text.length ? props.text + hinttext: prompttext) + "</em></div>";
        return html;
      },
      methods: {
        submitInput: function() {
          if (!this.data.text || !('target' in this.data)) return
          this.data.target = this.data.text
          this.data.text = ''
        }
      },
      listeners: {
        input: function(e) {var props = this.data; props.text = e.target.value},
        keydown: function (e) { if (e.key==='Enter') this.methods.submitInput() }
      }
    })

    // ================  todos
    reefer.register ('todos', {
      data: {
        todos: [],
        datasrc: 'data.todos',
        datactx: 'data',
        genkey: true,
        checked: false,
      },
      slots: {
        default: {
          script: reefer.template('d,i,ctx', 
                                  "<div class='${(d.class&&d.class[ctx.targetlist])||\"\"}'><label>\
                                      <input type='checkbox' \
                                             reef@click='methods.checkAndAssign(${d.__key__},$event)' \
                                             ${ctx.checked ?  'checked' : ''}></input>\
                                      <span class=textshadow>${d[0]}</span>\
                                    </label></div>")
        }
      },
      methods: {
        checkAndAssign: function (id,event) {
          var rf = this
          var idx = this.htmlKeyToIdx(id) | 0
          var targetReef = reefer.find (rf.data.targetlist)
          if (!targetReef && targetReef.name!='todos') throw Error ("no target todo list found")
          var todo = rf.data.todos[idx-1]
          if (todo.leaving) return 

          //animating it...
          todo.class = todo.class || {}
          todo.class[this.data.targetlist] = 'remove'
          todo.class[targetReef.data.targetlist] = this.data.checkclass
          targetReef.data.todos.splice (0, 0, todo)
          todo.leaving = true
          setTimeout(function() { // could listen to animation end event also....
            var idx = rf.htmlKeyToIdx(id)
            todo.leaving = false
            todo.class = todo.class || {}
            if (idx===null) return
            rf.data.todos.splice(idx-1, 1)
          }, 1000) // matches css animation duration
        } 
      },
      observers: {
        inputtext: function() {
          if (!this.data.inputtext) return
          var todo =  [this.data.inputtext]
          this.data.inputtext = ''

          //animating it
          todo.class = todo.class || {}
          todo.class[this.data.targetlist] = 'add'
          this.data.todos.splice (0, 0, todo)

        }
      }      
    })


    function getOffset(el) {
      if (!el.getClientRects().length) return { top: 0, left: 0 }
      var rect = el.getBoundingClientRect();
      var win = el.ownerDocument.defaultView;
      return {
        top: rect.top + win.pageYOffset,
        left: rect.left + win.pageXOffset,
        width: rect.width,
        height: rect.height 
      }   
    } 


    function reanimate_m(target, parent) {
      duration = duration || 1
      var elpos = getOffset (el)
      var tpos = getOffset (target)
      var ppos = getOffset (el.parentNode)
      var nel = el.cloneNode (true)
      var d = el.parentNode.cloneNode (false)
      var ds =  {
        position: 'absolute',
        margin: '0',
        padding: '0',
        border: 'none',
        display: 'block',
        transition: 'all ' + duration + 's',
        width: tpos.width + 'px',
        height: tpos.height + 'px',
        zIndex: 1000       
      }
      nel.removeAttribute ('id')
      reefer.styleBag (d,ds)
      el.parentNode.insertBefore (d, el)
      d.appendChild (nel)
      var p1 =  {
        left: 0,
        top: 0,
        width: elpos.width + 'px',
        height: elpos.height + 'px'
      }
      reefer.styleBag (d, p1)
      requestAnimationFrame(function () {
        var p2 =  {
          left: (tpos.left - elpos.left) + 'px',
          top: (tpos.top - elpos.top) + 'px',
          width: tpos.width + 'px',
          height: tpos.height + 'px',
        }
        reefer.styleBag (d,p2)
        setTimeout (function () {
          document.body.removeChild(d)
        }, (duration*1000)+30)
      })
    }

    function reanimate(target, el, duration) {
      duration = duration || 1
      var elpos = getOffset (el)
      var tpos = getOffset (target)
      var nel1 = el.cloneNode (true)
      var nel2 = target.cloneNode (true)
      var d1 = el.parentNode.cloneNode(false)
      var d2 = target.parentNode.cloneNode(false)
      var ds =  {
        margin: '0',
        padding: '0',
        border: 'none',
        display: 'block',
        transition: 'all ' + duration + 's',
        zIndex: 1000,
        overflow: 'hidden'
      }
      nel1.removeAttribute ('id')
      nel2.removeAttribute ('id')
      reefer.styleBag (d1,ds)
      reefer.styleBag (d2,ds)
      document.body.appendChild (d1)
      document.body.appendChild (d2)
      d1.appendChild (nel1)
      d2.appendChild (nel2)
      var p1 =  {
        position: 'absolute',
        left: elpos.left + 'px',
        top: elpos.top + 'px',
        width: elpos.width + 'px',
        height: elpos.height + 'px'
      }
      d1.style.opacity = 1
      d2.style.opacity = 0
      reefer.styleBag (d1, p1)
      reefer.styleBag (d2, p1)
      requestAnimationFrame(function () {
        var p2 =  {
          left: tpos.left + 'px',
          top: tpos.top + 'px',
          width: tpos.width + 'px',
          height: tpos.height + 'px',
        }
        reefer.styleBag (d1,p2)
        reefer.styleBag (d2,p2)
        d1.style.opacity = 0
        d2.style.opacity = 1
        setTimeout (function () {
          document.body.removeChild(d1)
          document.body.removeChild(d2)
        }, (duration*1000)+30)
      })
    }
        /*var $element = $(this);
        
        newParent = $(newParent); // Allow passing in either a JQuery object or selector
        var oldOffset = $element.offset();
        var oldWidth = $element.width();
        var oldHeight = $element.height();
        $(this).appendTo(newParent);
        var newOffset = $element.offset();
        var newWidth = $element.width();
        var newHeight = $element.height();
        
        var temp = $element.clone().removeAttr('id').appendTo('body');
        
        temp.css({
            'position': 'absolute',
            'left': oldOffset.left,
            'top': oldOffset.top,
            'width': oldWidth,
            'height': oldHeight,
            'zIndex': 1000
        });
        
        $element.hide();
            
        temp.animate({
            'top': newOffset.top,
            'left': newOffset.left,
            'width': newWidth,
            'height': newHeight
        }, duration, function() {
            $element.show();
            temp.remove();
        });
    }*/
</script>
</body>
</html>
